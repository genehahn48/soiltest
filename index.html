<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soil test map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<style>
</style>

<body>

  <header>
    <h1>Soil Test Data Single Crop Map</h1>
    <h2>Select year, nutrient, and crop type.</h2>
  </header>
  <div class="grid-container">

    <div class="map-1">
      <form name="map01">
        <label for="yearMap1">Year</label>
        <input type="range" min=1990 max=2019 step=1 id="yearMap1" value=2010 oninput="selected_yearMap1.value = yearVal(this.value)">
        <output name="selected_yearMap1" id="selected_year1">2010</output>
        <!-- chemical selection radio button map01 -->
        <input type="radio" id="p" name="chemMap01" onclick="nutVal(this.value)" value="P" checked>
        <label for="P">Phosphorus</label>
        <input type="radio" id="k" name="chemMap01" onclick="nutVal(this.value)" value="K">
        <label for="K">Potassium</label>

        <select id="dropdown" name="dropdown" class="dropdown" onchange="crop(this.value)">
          <option value="alfalfaMedData">Alfalfa</option>
          <option value="canolaMedData">Canola</option>
          <option value="coolseasonMedData">Cool Season Grass</option>
          <option value="cornMedData">Corn</option>
          <option value="smallgrainsMedData">Small Grains</option>
          <option value="sorghumMedData">Sorghum</option>
          <option value="soyMedData">SoyBeans</option>
          <option value="tobaccoMedData">Tobacco</option>
          <option value="warmseasonMedData">Warm Season Grass</option>
    </div>
    </select>
    </form>
    <div id="legend"></div>
    <div id="map-01"></div>
  </div>

  <div class="map-2">
    <form name="map02">
      <label for="yearMap2">Year</label>
      <input type="range" min=1990 max=2019 step=1 id="yearMap2" value=2010 oninput="selected_yearMap2.value = yearVal2(this.value)">
      <output name="selected_yearMap2" id="selected_year">2010</output>
      <!-- chemical selection radio button map01 -->
      <input type="radio" id="p" name="chemMap02" onclick="nutVal2(this.value)" value="P" checked>
      <label for="P">Phosphorus</label>
      <input type="radio" id="k" name="chemMap02" onclick="nutVal2(this.value)" value="K">
      <label for="k">Potassium</label>
      <div class="filterCrop">
      </div>
    </form>
    <div id="legend2"></div>
    <div id="map-02"></div>
  </div>

  <!-- <div class="map-3 blue" id="map-03" class="blue"> -->
  <div class="map-3 blue">
    <form name="map03">
      <label for="yearMap3">Year</label>
      <input type="range" min=1990 max=2019 step=1 id="yearMap3" value=2010 oninput="selected_yearMap3.value = yearVal3(this.value)">
      <output name="selected_yearMap3" id="selected_year">2010</output>
      <!-- chemical selection radio button map01 -->
      <!-- <input type="radio" id="p" name="chemMap03" onclick="nutVal3(this.value)" value="P" checked>
      <label for="P">Phosphorus</label>
      <input type="radio" id="k" name="chemMap03" onclick="nutVal3(this.value)" value="K">
      <label for="k">Potassium</label> -->
      <select id="dropMap3" name="dropdown" class="dropdown" onchange="crop(this.value)">
        <option value="alfalfaMedData">Alfalfa</option>
        <option value="canolaMedData">Canola</option>
        <option value="coolseasonMedData">Cool Season Grass</option>
        <option value="cornMedData">Corn</option>
        <option value="smallgrainsMedData">Small Grains</option>
        <option value="sorghumMedData">Sorghum</option>
        <option value="soyMedData">SoyBeans</option>
        <option value="tobaccoMedData">Tobacco</option>
        <option value="warmseasonMedData">Warm Season Grass</option>
    </div>
    </select>

    </form>

    <div id="map-03"></div>
  </div>

  <div class="map-4 green">
    <div id="map-04" class="green">Map #4</div>
  </div>
  </div>
  </div>
  <footer>
    <p>Map authored by Gene</p>
    <p>More information here ...</p>
  </footer>

  <!-- load D3 library -->
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <!-- load D3 color  -->
  <script src="https://d3js.org/d3-color.v1.min.js"></script>
  <!-- load jQuery library -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <!-- load TopoJSON -->
  <script src="https://unpkg.com/topojson@3"></script>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
  <!-- load global variables from variables.js files -->
  <script type="text/javascript" src="js/variables.js"></script>
  <script>
    // variables for leaflet maps Start map variables
    var map01 = L.map('map-01').setView([37.8, -85.65], 7);
    L.tileLayer('http://b.tilecloudmade.com/e7b61e61295a44a5b319ca0bd3150890/997/256/18/149531/108306.png', {
       // attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
        Control: false,
        maxZoom: 10, // set maxZoom to county level
        minZoom: 6, // set minZoom to State of Kentucky
        }).addTo(map01),

      map02 = L.map('map-02').setView([37.8, -85.65], 7);
      L.tileLayer('http://b.tilecloudmade.com/e7b61e61295a44a5b319ca0bd3150890/997/256/18/149531/108306.png', {
         // attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
        maxZoom: 10, // set maxZoom to county level
        minZoom: 7, // set minZoom to State of Kentucky
      }).addTo(map02),

      map03 = L.map('map-03').setView([37.8, -85.65], 7);
      L.tileLayer('http://b.tilecloudmade.com/e7b61e61295a44a5b319ca0bd3150890/997/256/18/149531/108306.png', {
         // attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
        maxZoom: 10, // set maxZoom to county level
        minZoom: 7, // set minZoom to State of Kentucky
      }).addTo(map03),

      map04 = L.map('map-04').setView([37.8, -85.65], 7);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
      // attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 10, // set maxZoom to county level
      minZoom: 7, // set minZoom to State of Kentucky
    }).addTo(map04)
    // End map variables

    // object select variable
    let cropval = "alfalfaMedData"

    // get width and height of maps with jQuery
    var wMap1 = $("#map-01").width(),
      hMap1 = $("#map-01").height(),
      widthForLegend = 100
    // console.log(wMap1 + " :width" + hMap1 + ": height")
    //Define color for map and legend
    var colorbrewer = {
      YlOrRd: {
        9: ["#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026", "#800026"]
      }
    };

    // wait until they are ready and then send to dataReady function
    Promise.all([countiesJson, regionsJson, alfalfaLevel, canolaLevel, coolseasonLevel, cornLevel,
      smallgrainsLevel, sorghumLevel, soyLevel, tobaccoLevel,
      warmseasonLevel, alfalfaMedCsv, canolaMedCSV, coolseasonMedCSV,
      cornMedCSV, smallgrainsMedCSV, sorghumMedCSV, soyMedCSV, tobaccoMedCSV, warmseasonMedCSV
    ]).then(dataReady, error);

    // function fired if there is an error
    function error(error) {
      console.log(error)
    }
    // load data with dataReady function
    function dataReady(data) {
      // reference the counties GeoJSON data
      const countiesJson = data[0];
      const regionsJson = data[1];
      // reference the data set, the CSV
      const alfalfa = data[2];
      const canola = data[3];
      const coolseason = data[4];
      const corn = data[5];
      const smallgrains = data[6];
      const sorghum = data[7];
      const soy = data[8];
      const tobacco = data[9];
      const warmseason = data[10];
      const alfalfaMedData = data[11];
      const canolaMedData = data[12];
      const coolseasonMedData = data[13];
      const cornMedData = data[14];
      const smallgrainsMedData = data[15];
      const sorghumMedData = data[16];
      const soyMedData = data[17];
      const tobaccoMedData = data[18];
      const warmseasonMedData = data[19];
      // here we want to bind CSV data to the county GeoJSON
      // create variable bindData to loop all csv files in leaflet bind features to json
      const bindData = [alfalfa, canola, coolseason, corn, smallgrains, sorghum, soy, tobacco, warmseason,
        alfalfaMedData, canolaMedData, coolseasonMedData, cornMedData, smallgrainsMedData,
        sorghumMedData, soyMedData, tobaccoMedData, warmseasonMedData
      ];
      // create variable to name loop data bind to GeoJSON
      const bindName = loCroptype;
      MedData.forEach(function(x) {
        bindName.push(x)
      })

      // loop bindData and send bindName to name crops
      bindData.forEach(function(bindData, x) {
        // loop through the county features
        countiesJson.features.forEach(function(feature) {
          bindData.forEach(function(row, i) {
            // if the county name and CSV name match
            if (row.COUNTY == feature.properties.name) {

              // create a new property for the csv data in the json and assign the data
              feature.properties[bindName[x]] = row;
            }
          })
        })
      });
      // double check that the bind was successful
      // console.log(data[0], "county data");
      var countyData = data[0];
      // console.log(data[1], "region");
      // console.log(countiesJson);
      // console.log(regionsJson);
      console.log(nutValmap1 + " : Map1");
      // console.log(yearValMap1);
      // console.log(nutValmap1 + "_med" + yearValMap1)
      // draw geojson to the map
      // L.geoJson(countyData,{style: style}).addTo(map01);
      // L.geoJson(data[1]).addTo(map01); // regions of KY
      L.geoJson(data[0]).addTo(map02);
      // L.geoJson(data[0]).addTo(map03);
      L.geoJson(data[1]).addTo(map04);
      console.log(cropval)
      console.log(countyData)
      // getting axcess to median data
      // countyData.features.forEach(function(county) {
      //   var currentPropName = nutValmap1 + "_med" + yearValMap1;
      //   console.log(county.properties[cropval][currentPropName]);
      // })
      drawMap(countyData, map01);
      drawMap(countyData, map03);

    }; // END dataReady
    var legend = L.control({position: 'topleft'});

    legend.onAdd = function (map01) {

        var div = L.DomUtil.create('map-01', 'legend'),
            grades = [0,5,7,27,60,80],
            labels = [];

        // loop through our density intervals and generate a label with a colored square for each interval
        for (var i = 0; i < grades.length; i++) {
            div.innerHTML +=
                '<i style="background:' + getColorP(grades[i] + 1) + '"></i> ' +
                grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
        }

        return div;
    };

    legend.addTo(map01);

    function drawMap(countyData, map) {
      L.geoJson(countyData, {
        style: style
      }).addTo(map);
    };
    // get option from dropdown Start
    function crop() {
      // get references to select list and display text box
      var sel = document.getElementById("dropdown");
      let cropval = sel.value
      console.log(cropval + " : crop value")
      return cropval
    }; // End dropdown get Value

    // immediate function to preserve global namespace
    // color for Phosphorus
    function getColorP(d) {
      return d > 80 ? '#980043' :
        d >= 60 ? '#dd1c77' :
        d >= 27 ? '#df65b0' :
        d >= 7 ? '#d7b5d8' :
        d >= 5 ? '#f1eef6' :
        d = 0 ? '#edf8fb' :
        '#edf8fb';
    }
    // color for Potassium
    function getColorK(d) {
      return d > 420 ? '#2B4F4F ' :
        d >= 420 ? '#4A6565' :
        d >= 300 ? '#606F6F' :
        d >= 190 ? '#818989 ' :
        d >= 100 ? '#A7B0B0' :
        d = 0 ? '#D3DADA' :
        '#D3DADA';
    }
    // style color map for median data Start
    function style(feature) {
      // console.log(nutValmap1+": style function")
      if (nutValmap1 = "P") {
        // console.log(feature)
        var currentPropName = nutValmap1 + "_med" + yearValMap1;
        //   console.log(county.properties[cropval][currentPropName]);
        console.log()
        return {
          fillColor: getColorP(feature.properties[cropval][currentPropName]),
          weight: 1,
          opacity: 1,
          color: '#484C51 ',
          solidline: '3',
          fillOpacity: 0.8
        };
      } else {
        return {
          fillColor: getColorK(feature.properties[cropval][currentPropName]),
          weight: .5,
          opacity: 1,
          color: '#484C51  ',
          solidline: '3',
          fillOpacity: 0.8
        };
      }
    }; // Median data color sytle END

    function nutVal(n, countyData) {
      console.log(countyData + ": countyData NutVal")
      console.log(n + ": map1")
      var nutValmap1 = n
      return nutValmap1
    };

    function nutVal2(n) {
      console.log(n + "map2")
      var nutValmap2 = n
      return nutValmap2
    };

    function nutVal3(n) {
      console.log(n + "map3")
      var nutValmap3 = n
      return nutValmap3
    };

    function yearVal(n) {
      console.log(n + ": map1 year")
      var yearValMap1 = n
      return yearValMap1
    };

    function yearVal2(n) {
      console.log(n + ": map2 year")
      yearValMap2 = n
      return yearValMap2
    };

    function yearVal3(n) {
      console.log(n + ": map3 year")
      yearValMap3 = n
      return yearValMap3
    };
  </script>
</body>

</html>
