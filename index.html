<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soil test map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<style>
</style>

<body>
  <header>
    <h1>Soil Test Data Single Crop Map</h1>
    <h2>Select year, nutrient, and crop type.</h2>
  </header>
  <div class="grid-container">
    <div class="map-1">
      <form name="map01">
        <label for="yearMap1">Year</label>
        <input type="range" min=1990 max=2019 step=1 id="yearMap1" value=2010>
        <output name="selected_yearMap1" id="selected_year1" value=> </output>
        <div id="map01-radios">
          <input type="radio" id="map01-p" name="chemMap01" value="P" checked>
          <label for="P">Phosphorus</label>
          <input type="radio" id="map01-k" name="chemMap01" value="K">
          <label for="K">Potassium</label>

          <select id="map01-dropdown" name="dropdown" class="dropdown">
            <option value="alfalfaMedData">Alfalfa</option>
            <option value="canolaMedData">Canola</option>
            <option value="coolseasonMedData">Cool Season Grass</option>
            <option value="cornMedData">Corn</option>
            <option value="smallgrainsMedData">Small Grains</option>
            <option value="sorghumMedData">Sorghum</option>
            <option value="soyMedData">SoyBeans</option>
            <option value="tobaccoMedData">Tobacco</option>
            <option value="warmseasonMedData">Warm Season Grass</option>
          </select>
      </form>
    </div>
    <div id="legend"></div>
    <div id="map-01"></div>
  </div>
  <div class="map-2">
    <form name="map02">
      <label for="yearMap2">Year</label>
      <input type="range" min=1990 max=2019 step=1 id="yearMap2" value=2010>
      <output name="selected_yearMap2" id="selected_year2">2010</output>
      <!-- chemical selection radio button map01 -->
      <input type="radio" id="p" name="chemMap02" value="P" checked>
      <label for="P">Phosphorus</label>
      <input type="radio" id="k" name="chemMap02" value="K">
      <label for="k">Potassium</label>
      <div class="filterCrop">
      </div>
    </form>
    <div id="legend2"></div>
    <div id="map-02"></div>
  </div>
  <div class="map-3 blue">
    <form name="map03">
      <label for="yearMap3">Year</label>
      <input type="range" min=1990 max=2019 step=1 id="yearMap3" value=2010>
      <output name="selected_yearMap3" id="selected_year3">2010</output>

      <select id="map03-dropdown" name="dropdown" class="dropdown">
        <option value="alfalfaMedData">Alfalfa</option>
        <option value="canolaMedData">Canola</option>
        <option value="coolseasonMedData">Cool Season Grass</option>
        <option value="cornMedData">Corn</option>
        <option value="smallgrainsMedData">Small Grains</option>
        <option value="sorghumMedData">Sorghum</option>
        <option value="soyMedData">SoyBeans</option>
        <option value="tobaccoMedData">Tobacco</option>
        <option value="warmseasonMedData">Warm Season Grass</option>
      </select>
    </form>
    <div id="map-03"></div>
  </div>
  <div class="map-4 green">
    <div id="map-04" class="green">Map #4</div>
  </div>
  </div>
  </div>
  <footer>
    <p>Map authored by Gene</p>
    <p>More information here ...</p>
  </footer>

  <!-- load D3 library -->
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <!-- load D3 color  -->
  <script src="https://d3js.org/d3-color.v1.min.js"></script>
  <!-- load jQuery library -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <!-- load TopoJSON -->
  <script src="https://unpkg.com/topojson@3"></script>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>

  <script>
    // Global variables for Soil test datasets
    // Request all your desired datasets first
    // Load county and region polygons
    const countiesJson = d3.json('project-data/ky-farm-ac.geojson');
    const regionsJson = d3.json('project-data/ky-regions.json');
    // Load nutrient values for each crop from CSV
    const alfalfaLevel = d3.csv('project-data/alfalfa_levels.csv');
    const canolaLevel = d3.csv('project-data/canola_levels.csv');
    const coolseasonLevel = d3.csv('project-data/coolseason_levels.csv');
    const cornLevel = d3.csv('project-data/corn_levels.csv');
    const smallgrainsLevel = d3.csv('project-data/smallgrains_levels.csv');
    const sorghumLevel = d3.csv('project-data/sorghum_levels.csv');
    const soyLevel = d3.csv('project-data/soy_levels.csv');
    const tobaccoLevel = d3.csv('project-data/tobacco_levels.csv');
    const warmseasonLevel = d3.csv('project-data/warmseason_levels.csv');
    // Load median values for all categories from Agr1
    const alfalfaMedCsv = d3.csv('project-data/alfalfa_median.csv');
    const canolaMedCSV = d3.csv('project-data/canola_median.csv');
    const coolseasonMedCSV = d3.csv('project-data/coolseason_median.csv');
    const cornMedCSV = d3.csv('project-data/corn_median.csv');
    const smallgrainsMedCSV = d3.csv('project-data/smallgrains_median.csv');
    const sorghumMedCSV = d3.csv('project-data/sorghum_median.csv');
    const soyMedCSV = d3.csv('project-data/soy_median.csv');
    const tobaccoMedCSV = d3.csv('project-data/tobacco_median.csv');
    const warmseasonMedCSV = d3.csv('project-data/warmseason_median.csv');

    // Global variables
    const loCroptype = ["alfalfa", "canola", "coolseason", "corn", "smallgrains", "sorghum", "soy", "tobacco", "warmseason"];
    const selYear = [1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019];
    const minYear = Math.min.apply(Math, selYear); // get min year
    const maxYear = Math.max.apply(Math, selYear); // get max year
    const selNutrient = ["Phosphorus", "Potassium"];
    const MedData = ["alfalfaMedData", "canolaMedData", "coolseasonMedData", "cornMedData", "smallgrainsMedData", "sorghumMedData", "soyMedData", "tobaccoMedData", "warmseasonMedData"];
    // set initial variables that change with selection options
    let nutValmap1 = "P";
    let yearVal = $('#yearMap1').val(); //jquery yearVal from slider
    let yearVal3 = $('#yearMap3').val(); //jquery yearVal from slider
    console.log(yearVal3)
    // variables for leaflet maps Start map variables
    const map01 = L.map('map-01').setView([37.8, -85.65], 7);
    const map02 = L.map('map-02').setView([37.8, -85.65], 7);
    const map03 = L.map('map-03').setView([37.8, -85.65], 7);
    const map04 = L.map('map-04').setView([37.8, -85.65], 7);

    // object select variable
    let cropval = "alfalfaMedData"

    // get width and height of maps with jQuery
    const wMap1 = $("#map-01").width();
    const hMap1 = $("#map-01").height();
    const widthForLegend = 100;

    //Define color for map and legend
    // const colorbrewer = {
    //   YlOrRd: {
    //     9: ["#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026", "#800026"]
    //   }
    // };

    // some global variables here, perhaps, to reference the Leaflet GeoJSON layers
    // created within the drawMaps function
    let map01LGeoJson;

    // wait until they are ready and then send to dataReady function
    Promise.all([countiesJson, regionsJson, alfalfaLevel, canolaLevel, coolseasonLevel, cornLevel,
      smallgrainsLevel, sorghumLevel, soyLevel, tobaccoLevel,
      warmseasonLevel, alfalfaMedCsv, canolaMedCSV, coolseasonMedCSV,
      cornMedCSV, smallgrainsMedCSV, sorghumMedCSV, soyMedCSV, tobaccoMedCSV, warmseasonMedCSV
    ]).then(dataReady, error);

    // function fired if there is an error
    function error(error) {
      console.log(error)
    }
    // load data with dataReady function
    function dataReady(data) {
      // reference the counties GeoJSON data
      const countiesJson = data[0];
      const regionsJson = data[1];
      // reference the data set, the CSV
      const alfalfa = data[2];
      const canola = data[3];
      const coolseason = data[4];
      const corn = data[5];
      const smallgrains = data[6];
      const sorghum = data[7];
      const soy = data[8];
      const tobacco = data[9];
      const warmseason = data[10];
      const alfalfaMedData = data[11];
      const canolaMedData = data[12];
      const coolseasonMedData = data[13];
      const cornMedData = data[14];
      const smallgrainsMedData = data[15];
      const sorghumMedData = data[16];
      const soyMedData = data[17];
      const tobaccoMedData = data[18];
      const warmseasonMedData = data[19];
      // here we want to bind CSV data to the county GeoJSON
      // create variable bindData to loop all csv files in leaflet bind features to json
      const bindData = [alfalfa, canola, coolseason, corn, smallgrains, sorghum, soy, tobacco, warmseason,
        alfalfaMedData, canolaMedData, coolseasonMedData, cornMedData, smallgrainsMedData,
        sorghumMedData, soyMedData, tobaccoMedData, warmseasonMedData
      ];
      // create variable to name loop data bind to GeoJSON
      const bindName = loCroptype;
      MedData.forEach(function(x) {
        bindName.push(x)
      })
      console.log(bindName)
      // loop bindData and send bindName to name crops
      bindData.forEach(function(bindDatum, x) {
        // console.log(bindDatum[x]+" :binData"+x)
        // loop through the county features
        countiesJson.features.forEach(function(feature) {
          bindDatum.forEach(function(row, i) {
            // if the county name and CSV name match
            if (row.COUNTY == feature.properties.name) {
              console.log(row.COUNTY+": rowCOUNTY")
              console.log(row)
              console.log(feature.properties.name)
              // create a new property for the csv data in the json and assign the data
              feature.properties[bindName[x]] = row;

              console.log(feature.properties[bindName[x]])
            }else{

            }
          })
        })
      });

      drawMaps(countiesJson);
      addListeners();
      // addLegends();
    }; // END dataReady



    function drawMaps(countyData) {
      // function will be called once and create L.geoJson objects from data
      nutVal = nutValmap1 // general variable for styling
      // assign value to variable declared above
      map01LGeoJson = L.geoJson(countyData).addTo(map01);
      addLegendP("map01")
      // L.geoJson(countyData).addTo(map02);
      map03LGeoJson = L.geoJson(countyData).addTo(map03);
      // L.geoJson(countyData, {
      //   style: style
      // }).addTo(map03);

      // L.geoJson(data[1]).addTo(map04);

      // call the styleMaps() function to apply visual representation
      styleMaps(map01LGeoJson, nutVal, yearVal);

      styleMaps(map03LGeoJson, nutVal, yearVal);
    }

    function addLegendP(map) {
      var legend = L.control({
        position: 'topleft'
      });
        map01.removeControl(legend);
      legend.onAdd = function(map) {

        var div = L.DomUtil.create('map', 'legend'),
          legVal = [0, 5, 7, 27, 60, 80],
          labels = [];

        // loop through our nutrient value intervals and generate a label with a colored square for each interval
        for (var i = 0; i < legVal.length; i++) {
          div.innerHTML +=
            '<i style="background:' + getColorP(legVal[i] + 1) + '"></i> ' +
            legVal[i] + (legVal[i + 1] ? '&ndash;' + legVal[i + 1] + '<br>' : '+');
        }

        return div;
      };
      // console.log(typeof map+" : addLegend after return")
      //         legend.addTo(valueOf(map));
      legend.addTo(map01);

      var legend3 = L.control({
        position: 'topleft'
      });
      legend3.onAdd = function(map) {

        var div = L.DomUtil.create('map', 'legend'),
          legVal = [0, 5, 7, 27, 60, 80],
          labels = [];

        // loop through our nutrient value intervals and generate a label with a colored square for each interval
        for (var i = 0; i < legVal.length; i++) {
          div.innerHTML +=
            '<i style="background:' + getColorP(legVal[i] + 1) + '"></i> ' +
            legVal[i] + (legVal[i + 1] ? '&ndash;' + legVal[i + 1] + '<br>' : '+');
        }

        return div;
      };
      // console.log(typeof map+" : addLegend after return")
      //         legend.addTo(valueOf(map));
      legend3.addTo(map03);
}
      function addLegendK(map) {
        var legend = L.control({
          position: 'topleft'
        });
map01.removeControl(legend);
        legend.onAdd = function(map01) {

            var div = L.DomUtil.create('map-01', 'legend'),
              legVal = [0, 100, 190, 300, 420],
              labels = [];

            // loop through our nutrient value intervals and generate a label with a colored square for each interval
            for (var i = 0; i < legVal.length; i++) {
              div.innerHTML +=
                '<i style="background:' + getColorK(legVal[i] + 1) + '"></i> ' +
                legVal[i] + (legVal[i + 1] ? '&ndash;' + legVal[i + 1] + '<br>' : '+');
            }

            return div;
          };

          legend.addTo(map01);
          var legend3 = L.control({
            position: 'topleft'
          });

          legend3.onAdd = function(map01) {

              var div = L.DomUtil.create('map-03', 'legend'),
                legVal = [0, 100, 190, 300, 420],
                labels = [];

              // loop through our nutrient value intervals and generate a label with a colored square for each interval
              for (var i = 0; i < legVal.length; i++) {
                div.innerHTML +=
                  '<i style="background:' + getColorK(legVal[i] + 1) + '"></i> ' +
                  legVal[i] + (legVal[i + 1] ? '&ndash;' + legVal[i + 1] + '<br>' : '+');
              }

              return div;
            };

            legend3.addTo(map03);
                  }

      function styleMaps(map, nutVal, yearVal) {
        // function will be called multiple times, once within drawMaps
        // and then multiple times triggered by the UI changes
        console.log(nutVal + ": NUTVALUE STYLEAPS" + yearVal)
        if (nutVal == "P") {
          map.setStyle(styleP);
        } else {
          map.setStyle(styleK);
        }
      }

      function addListeners() {
        // select the HTML UI elements and extract value attribute
        $('#map01-radios input').on('change', function() { //nutrient value change
          nutVal = (this.value) //  nutVal P or K onchange
          console.log(nutVal)
if(nutVal == "P"){
  addLegendP()
}else{
  addLegendK()
}

          styleMaps(map01LGeoJson, nutVal);
          styleMaps(map03LGeoJson, nutVal);
        });
        $('#map01-dropdown').on('change', function(event, d) {
          cropval = (this.value) // crop types from Agr1
          console.log(cropval) // get value from dropdown crop type
          styleMaps(map01LGeoJson, nutVal);
        });
        $('#map03-dropdown').on('change', function(event, d) {
          cropval = (this.value) // crop types from Agr1
          console.log(cropval) // get value from dropdown crop type
          styleMaps(map03LGeoJson, nutVal, yearVal);
        });
        $('#yearMap1').on('change', function(event, d) {
          yearVal = (this.value) // crop types from Agr1
          console.log(yearVal) // get value from dropdown crop type
          styleMaps(map01LGeoJson, nutVal, yearVal);
        });
        $('#yearMap3').on('change', function(event, d) {
          yearVal = (this.value) // crop types from Agr1
          console.log(yearVal) // get value from dropdown crop type
          styleMaps(map03LGeoJson, nutVal, yearVal);
        });
      }


      // immediate function to preserve global namespace
      // color for Phosphorus
      function getColorP(d) {
        return d > 80 ? '#980043' :
          d >= 60 ? '#dd1c77' :
          d >= 27 ? '#df65b0' :
          d >= 7 ? '#d7b5d8' :
          d >= 5 ? '#f1eef6' :
          d = 0 ? '#edf8fb' :
          '#edf8fb';
      }
      // color for Potassium
      function getColorK(d) {
        return d > 420 ? '#2B4F4F ' :
          d >= 420 ? '#4A6565' :
          d >= 300 ? '#606F6F' :
          d >= 190 ? '#818989 ' :
          d >= 100 ? '#A7B0B0' :
          d = 0 ? '#D3DADA' :
          '#D3DADA';
      }
      // style color map for median data P and K Start
      function styleP(feature) {
        // console.log(cropval + " :SYTLE P Function" + yearVal);
        var currentPropName = "P_med" + yearVal;
        // console.log(feature.properties[cropval][currentPropName] + ": styleP getcolorP")
        return {
          fillColor: getColorP(feature.properties[cropval][currentPropName]),
          weight: 1,
          opacity: 1,
          color: '#484C51 ',
          solidline: '3',
          fillOpacity: 0.8
        };
      }

      function styleK(feature) {
        var currentPropName = "K_med" + yearVal;
        console.log(cropval + " :SYTLE K Function" + yearVal);
        return {

          fillColor: getColorK(feature.properties[cropval][currentPropName]),
          weight: .5,
          opacity: 1,
          color: '#484C51  ',
          solidline: '3',
          fillOpacity: 0.8
        };
      } // END P and K style
  </script>
</body>

</html>
